//! Reproduce double-drop unsoundness in
//! `VecExt::insert_slice_clone` (qwutils â‰¤ 0.3.0).

use qwutils::VecExt;           // The extension trait that adds `insert_slice_clone`

// A type whose `Clone` implementation always panics
struct DropDetector(u32);

impl Drop for DropDetector {
    fn drop(&mut self) {
        println!("Dropping {}", self.0);
    }
}

impl Clone for DropDetector {
    fn clone(&self) -> Self {
        panic!("DropDetector {} panic on clone()", self.0);
    }
}

fn main() {
    // Vector we will mutate
    let mut a = vec![DropDetector(1), DropDetector(2)];
    // Slice we will insert (cloning its single element panics)
    let b = [DropDetector(3)];

    // Trigger the bug
    a.insert_slice_clone(0, &b);
}
